<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaSwarm — Robot Design Reference</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap');
:root {
  --navy:#05101f; --navy2:#0a1e38; --cyan:#00d4ff; --cyan2:#0088aa;
  --red:#c41e3a; --green:#00ff88; --amber:#ffaa00; --white:#e8f4f8;
  --mono:'Share Tech Mono',monospace; --head:'Barlow Condensed',sans-serif; --body:'Barlow',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--navy);color:var(--white);font-family:var(--mono);overflow:hidden;height:100vh;display:flex;flex-direction:column;}
/* HEADER */
header{
  flex-shrink:0;display:flex;align-items:center;justify-content:space-between;
  padding:10px 24px;background:rgba(5,16,31,0.95);
  border-bottom:1px solid rgba(0,212,255,0.2);z-index:20;
}
.logo{font-family:var(--head);font-weight:900;font-size:20px;letter-spacing:4px;color:var(--cyan);text-transform:uppercase;}
.logo span{color:var(--red);} .logo sub{font-size:9px;font-family:var(--mono);color:rgba(0,212,255,0.4);letter-spacing:2px;display:block;}
.hpills{display:flex;gap:8px;}
.pill{font-size:9px;letter-spacing:1.5px;padding:3px 9px;border:1px solid;border-radius:1px;}
.pc{border-color:rgba(0,212,255,0.3);color:var(--cyan);}
.pr{border-color:rgba(196,30,58,0.4);color:var(--red);}
.pg{border-color:rgba(0,255,136,0.3);color:var(--green);}

/* TAB BAR */
.tabbar{
  flex-shrink:0;display:flex;align-items:center;gap:0;
  background:rgba(5,16,31,0.9);border-bottom:1px solid rgba(0,212,255,0.12);
  padding:0 24px;
}
.tab{
  font-family:var(--head);font-size:12px;font-weight:700;letter-spacing:2px;
  text-transform:uppercase;padding:9px 18px;cursor:pointer;
  color:rgba(0,212,255,0.4);border-bottom:2px solid transparent;
  transition:all .15s;background:transparent;border-top:none;border-left:none;border-right:none;
}
.tab:hover{color:var(--cyan);}
.tab.on{color:var(--cyan);border-bottom-color:var(--red);}
.tab-sep{color:rgba(0,212,255,0.15);font-size:18px;user-select:none;}

/* MAIN AREA */
.main{flex:1;display:flex;overflow:hidden;position:relative;}

/* CANVAS PANELS */
.canvases{flex:1;display:grid;grid-template-columns:1fr 1fr;gap:0;position:relative;}
.cv-wrap{
  position:relative;overflow:hidden;
  border-right:1px solid rgba(0,212,255,0.1);
}
.cv-wrap:last-child{border-right:none;}
canvas{display:block;width:100%;height:100%;}

.cv-label{
  position:absolute;top:12px;left:0;right:0;
  display:flex;align-items:center;justify-content:center;gap:8px;
  pointer-events:none;
}
.cv-badge{
  font-family:var(--head);font-size:11px;font-weight:700;letter-spacing:3px;
  text-transform:uppercase;padding:4px 14px;
  border:1px solid;
}
.badge-a{border-color:rgba(0,212,255,0.5);color:var(--cyan);background:rgba(0,212,255,0.06);}
.badge-b{border-color:rgba(196,30,58,0.5);color:var(--red);background:rgba(196,30,58,0.06);}

.cv-hint{
  position:absolute;bottom:10px;left:0;right:0;text-align:center;
  font-size:8px;color:rgba(0,212,255,0.25);letter-spacing:1.5px;pointer-events:none;
}

/* RIGHT PANEL */
#infoPanel{
  width:320px;flex-shrink:0;
  background:rgba(5,16,31,0.96);
  border-left:1px solid rgba(0,212,255,0.12);
  display:flex;flex-direction:column;overflow-y:auto;
}
.psec{padding:14px 16px;border-bottom:1px solid rgba(0,212,255,0.08);}
.ptitle{
  font-size:8px;letter-spacing:3px;color:var(--cyan);text-transform:uppercase;
  margin-bottom:10px;display:flex;align-items:center;gap:6px;
}
.ptitle::before{content:'';display:block;width:3px;height:11px;background:var(--red);flex-shrink:0;}

/* SPEC TABLE */
.spec-table{width:100%;border-collapse:collapse;font-size:10px;}
.spec-table th{font-size:8px;letter-spacing:1.5px;color:rgba(0,212,255,0.45);text-transform:uppercase;padding:4px 6px;text-align:left;border-bottom:1px solid rgba(0,212,255,0.08);}
.spec-table td{padding:5px 6px;border-bottom:1px solid rgba(0,212,255,0.05);vertical-align:top;}
.spec-table td:first-child{color:rgba(0,212,255,0.6);width:42%;}
.spec-table td.va{color:var(--cyan);}
.spec-table td.vb{color:var(--red);}

/* BOM TABLE */
.bom{width:100%;border-collapse:collapse;font-size:9px;}
.bom th{font-size:7px;letter-spacing:1.5px;color:rgba(0,212,255,0.4);text-transform:uppercase;padding:3px 5px;text-align:left;border-bottom:1px solid rgba(0,212,255,0.1);}
.bom td{padding:4px 5px;border-bottom:1px solid rgba(0,212,255,0.04);vertical-align:top;}
.bom td.cat{color:rgba(0,212,255,0.5);font-size:8px;}
.bom td.part{color:rgba(255,255,255,0.8);}
.bom td.price{text-align:right;color:var(--amber);white-space:nowrap;}
.bom td.note{color:rgba(255,255,255,0.35);font-size:8px;}
.bom tr.total td{color:var(--green);font-weight:bold;border-top:1px solid rgba(0,212,255,0.2);}
.bom tr:hover td{background:rgba(0,212,255,0.03);}

/* COMPONENT HIGHLIGHT */
.comp-btn{
  display:flex;align-items:center;gap:8px;padding:6px 8px;
  border:1px solid rgba(0,212,255,0.1);background:transparent;
  cursor:pointer;transition:all .15s;width:100%;text-align:left;margin-bottom:4px;
  font-family:var(--mono);font-size:9px;color:rgba(0,212,255,0.7);
  border-radius:1px;
}
.comp-btn:hover,.comp-btn.on{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,0.07);}
.comp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* SCROLLBAR */
::-webkit-scrollbar{width:3px;} ::-webkit-scrollbar-thumb{background:rgba(0,212,255,0.2);}
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">Aqua<span>Swarm</span> <sub>ROBOT DESIGN REFERENCE — REV 0.2 (AMPHIBIOUS)</sub></div>
  </div>
  <div class="hpills">
    <div class="pill pc">DUAL-TYPE COMPARISON</div>
    <div class="pill pg">AMPHIBIOUS CRAWLER</div>
    <div class="pill pr">FABRICATION-READY</div>
  </div>
</header>

<div class="tabbar">
  <button class="tab on" id="t0" onclick="setTab(0)">3D VIEW</button>
  <span class="tab-sep">|</span>
  <button class="tab" id="t1" onclick="setTab(1)">SPECIFICATIONS</button>
  <span class="tab-sep">|</span>
  <button class="tab" id="t2" onclick="setTab(2)">BILL OF MATERIALS</button>
  <span class="tab-sep">|</span>
  <button class="tab" id="t3" onclick="setTab(3)">COMPONENTS</button>
</div>

<div class="main">
  <div class="canvases" id="canvasArea">

    <!-- ROBOT A -->
    <div class="cv-wrap" id="wrapA">
      <canvas id="cvA"></canvas>
      <div class="cv-label">
        <div class="cv-badge badge-a">TYPE-A · POOL CLEANER AUV</div>
      </div>
      <div class="cv-hint">DRAG TO ROTATE · SCROLL TO ZOOM</div>
    </div>

    <!-- ROBOT B -->
    <div class="cv-wrap" id="wrapB">
      <canvas id="cvB"></canvas>
      <div class="cv-label">
        <div class="cv-badge badge-b">TYPE-B · TACTICAL MICRO-SWARM</div>
      </div>
      <div class="cv-hint">DRAG TO ROTATE · SCROLL TO ZOOM</div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="infoPanel">

    <!-- TAB 0: summary -->
    <div id="tab0">
      <div class="psec">
        <div class="ptitle">Design Overview</div>
        <table class="spec-table">
          <tr><th></th><th style="color:var(--cyan)">TYPE-A</th><th style="color:var(--red)">TYPE-B</th></tr>
          <tr><td>Mission</td><td class="va">Pool cleaning</td><td class="vb">Tactical ISR</td></tr>
          <tr><td>Chassis</td><td class="va">Wedge (L)</td><td class="vb">Wedge (S)</td></tr>
          <tr><td>Mobility</td><td class="va">Tracks (Amphibious)</td><td class="vb">Tracks (Amphibious)</td></tr>
          <tr><td>Weight</td><td class="va">~650 g</td><td class="vb">~180 g</td></tr>
          <tr><td>Depth</td><td class="va">5 m</td><td class="vb">30 m</td></tr>
          <tr><td>Battery</td><td class="va">18650 × 4 (14.8V)</td><td class="vb">LiPo 1S (3.7V)</td></tr>
          <tr><td>Runtime</td><td class="va">~90 min</td><td class="vb">~45 min</td></tr>
          <tr><td>Nav</td><td class="va">Sonar + IMU</td><td class="vb">IMU + Acoustic</td></tr>
          <tr><td>Payload</td><td class="va">Brush Head</td><td class="vb">Modular / None</td></tr>
          <tr><td>Cost</td><td class="va" style="color:var(--green)">~$320</td><td class="vb" style="color:var(--amber)">~$95</td></tr>
        </table>
      </div>
      <div class="psec">
        <div class="ptitle">Propulsion (Amphibious)</div>
        <table class="spec-table">
          <tr><th></th><th style="color:var(--cyan)">TYPE-A</th><th style="color:var(--red)">TYPE-B</th></tr>
          <tr><td>Main Drive</td><td class="va">Twin Brushless</td><td class="vb">Twin Brushless</td></tr>
          <tr><td>Downforce</td><td class="va">Vertical Thruster</td><td class="vb">Vertical Thruster</td></tr>
          <tr><td>Steering</td><td class="va">Differential</td><td class="vb">Differential</td></tr>
          <tr><td>Tracks</td><td class="va">Silicone Shore 40A</td><td class="vb">Silicone Shore 40A</td></tr>
        </table>
      </div>
      <div class="psec">
        <div class="ptitle">Waterproofing</div>
        <table class="spec-table">
          <tr><td>Hull Material</td><td class="va">PETG 3D Printed</td><td class="vb">PETG 3D Printed</td></tr>
          <tr><td>Sealing</td><td class="va">Epoxy / Potting</td><td class="vb">Epoxy / Potting</td></tr>
          <tr><td>Cable glands</td><td class="va">M8 × 4</td><td class="vb">M5 × 2</td></tr>
        </table>
      </div>
    </div>

    <!-- TAB 1: specs hidden by default -->
    <div id="tab1" style="display:none">
      <div class="psec">
        <div class="ptitle">TYPE-A Full Specs — Pool Cleaner AUV</div>
        <table class="spec-table">
          <tr><td>MCU</td><td class="va">Raspberry Pi Zero 2W</td></tr>
          <tr><td>Co-processor</td><td class="va">Arduino Nano (ESC/Servo)</td></tr>
          <tr><td>IMU</td><td class="va">MPU-9250 (9-DOF)</td></tr>
          <tr><td>Sonar</td><td class="va">JSN-SR04T (waterproof US)</td></tr>
          <tr><td>Propulsion</td><td class="va">2× Brushless + 1× Vertical</td></tr>
          <tr><td>Tracks</td><td class="va">Continuous Rubber Track</td></tr>
          <tr><td>Cleaning</td><td class="va">Motorized Brush Head</td></tr>
          <tr><td>Battery</td><td class="va">18650 × 4S1P = 14.8V 2.5Ah</td></tr>
          <tr><td>Charging</td><td class="va">Wireless Qi / Pogo</td></tr>
          <tr><td>Housing</td><td class="va">PETG Printed Wedge</td></tr>
          <tr><td>Inter-unit comm</td><td class="va">Acoustic modem (DIY FSK)</td></tr>
          <tr><td>Edge AI</td><td class="va">TFLite on RPi — flocking algo</td></tr>
        </table>
      </div>
      <div class="psec">
        <div class="ptitle">TYPE-B Full Specs — Tactical Micro AUV</div>
        <table class="spec-table">
          <tr><td>MCU</td><td class="vb">ESP32-S3 (dual-core 240MHz)</td></tr>
          <tr><td>IMU</td><td class="vb">ICM-42688-P (6-DOF high perf)</td></tr>
          <tr><td>Sonar</td><td class="vb">Ultrasonic transducer 40kHz</td></tr>
          <tr><td>Propulsion</td><td class="vb">2× Brushless 1104 + 1× Vert</td></tr>
          <tr><td>Tracks</td><td class="vb">Micro Silicone Tracks</td></tr>
          <tr><td>Battery</td><td class="vb">LiPo 1S 3.7V 800mAh</td></tr>
          <tr><td>Housing</td><td class="vb">PETG 3D print + epoxy coat</td></tr>
          <tr><td>Swarm comm</td><td class="vb">Acoustic pulse coding</td></tr>
          <tr><td>Dead reckoning</td><td class="vb">Kalman filter on ICM-42688</td></tr>
          <tr><td>Payload</td><td class="vb">Modular bay 2 cm³</td></tr>
        </table>
      </div>
    </div>

    <!-- TAB 2: BOM -->
    <div id="tab2" style="display:none">
      <div class="psec">
        <div class="ptitle">TYPE-A — Bill of Materials (~$320/unit)</div>
        <table class="bom">
          <tr><th>Category</th><th>Part</th><th>$</th></tr>
          <tr><td class="cat">Compute</td><td class="part">Raspberry Pi Zero 2W</td><td class="price">$15</td></tr>
          <tr><td class="cat"></td><td class="part">Arduino Nano clone</td><td class="price">$3</td></tr>
          <tr><td class="cat">Sensors</td><td class="part">MPU-9250 IMU module</td><td class="price">$4</td></tr>
          <tr><td class="cat"></td><td class="part">JSN-SR04T waterproof sonar</td><td class="price">$5</td></tr>
          <tr><td class="cat">Propulsion</td><td class="part">Brushless Motor × 3</td><td class="price">$45</td></tr>
          <tr><td class="cat"></td><td class="part">ESC 30A × 3</td><td class="price">$30</td></tr>
          <tr><td class="cat">Mobility</td><td class="part">Silicone Track Belts</td><td class="price">$12</td></tr>
          <tr><td class="cat">Cleaning</td><td class="part">775 waterproof DC motor</td><td class="price">$8</td></tr>
          <tr><td class="cat"></td><td class="part">Nylon brush head (custom)</td><td class="price">$4</td></tr>
          <tr><td class="cat">Power</td><td class="part">Samsung 18650 × 4</td><td class="price">$12</td></tr>
          <tr><td class="cat"></td><td class="part">BMS 4S 10A</td><td class="price">$5</td></tr>
          <tr><td class="cat">Housing</td><td class="part">PETG Filament (500g)</td><td class="price">$10</td></tr>
          <tr><td class="cat"></td><td class="part">Epoxy / Potting Compound</td><td class="price">$8</td></tr>
          <tr><td class="cat">Misc</td><td class="part">Bearings, Shafts, Wiring</td><td class="price">$15</td></tr>
          <tr class="total"><td colspan="2">TOTAL (TYPE-A / UNIT)</td><td class="price">~$320</td></tr>
        </table>
      </div>
      <div class="psec">
        <div class="ptitle">TYPE-B — Bill of Materials (~$95/unit)</div>
        <table class="bom">
          <tr><th>Category</th><th>Part</th><th>$</th></tr>
          <tr><td class="cat">Compute</td><td class="part">ESP32-S3 DevKit</td><td class="price">$5</td></tr>
          <tr><td class="cat">Sensors</td><td class="part">ICM-42688-P IMU breakout</td><td class="price">$8</td></tr>
          <tr><td class="cat"></td><td class="part">Ultrasonic transducer</td><td class="price">$3</td></tr>
          <tr><td class="cat">Propulsion</td><td class="part">Brushless 1104 2300kv × 3</td><td class="price">$21</td></tr>
          <tr><td class="cat"></td><td class="part">BLHeli-S 6A ESC × 3</td><td class="price">$12</td></tr>
          <tr><td class="cat">Power</td><td class="part">LiPo 1S 800mAh 30C</td><td class="price">$6</td></tr>
          <tr><td class="cat">Mobility</td><td class="part">Silicone Micro Tracks</td><td class="price">$5</td></tr>
          <tr><td class="cat">Housing</td><td class="part">PETG filament (150g)</td><td class="price">$5</td></tr>
          <tr><td class="cat"></td><td class="part">Epoxy coat</td><td class="price">$4</td></tr>
          <tr><td class="cat">Misc</td><td class="part">Wiring, micro connectors</td><td class="price">$4</td></tr>
          <tr class="total"><td colspan="2">TOTAL (TYPE-B / UNIT)</td><td class="price">~$95</td></tr>
        </table>
      </div>
    </div>

    <!-- TAB 3: components highlight -->
    <div id="tab3" style="display:none">
      <div class="psec">
        <div class="ptitle">Click to highlight on 3D model</div>
        <div id="compListA">
          <div style="font-size:9px;color:rgba(0,212,255,0.4);margin-bottom:6px;letter-spacing:1px;">— TYPE-A —</div>
          <button class="comp-btn" onclick="highlight('A','chassis')"><div class="comp-dot" style="background:#00d4ff"></div>WEDGE CHASSIS (PETG)</button>
          <button class="comp-btn" onclick="highlight('A','tracks')"><div class="comp-dot" style="background:#444"></div>SILICONE TRACKS</button>
          <button class="comp-btn" onclick="highlight('A','thruster')"><div class="comp-dot" style="background:#ff4466"></div>TWIN THRUSTERS</button>
          <button class="comp-btn" onclick="highlight('A','vthruster')"><div class="comp-dot" style="background:#ff8844"></div>VERTICAL THRUSTER</button>
          <button class="comp-btn" onclick="highlight('A','brush')"><div class="comp-dot" style="background:#00ff88"></div>BRUSH HEAD</button>
          <button class="comp-btn" onclick="highlight('A','battery')"><div class="comp-dot" style="background:#ffaa00"></div>18650 BATTERY PACK</button>
          <button class="comp-btn" onclick="highlight('A','compute')"><div class="comp-dot" style="background:#aa88ff"></div>RPi ZERO 2W</button>
          <button class="comp-btn" onclick="highlight('A','none')"><div class="comp-dot" style="background:#333"></div>CLEAR ALL</button>
        </div>
        <div id="compListB" style="margin-top:14px">
          <div style="font-size:9px;color:rgba(196,30,58,0.6);margin-bottom:6px;letter-spacing:1px;">— TYPE-B —</div>
          <button class="comp-btn" onclick="highlight('B','chassis')"><div class="comp-dot" style="background:#c41e3a"></div>WEDGE CHASSIS (S)</button>
          <button class="comp-btn" onclick="highlight('B','tracks')"><div class="comp-dot" style="background:#444"></div>MICRO TRACKS</button>
          <button class="comp-btn" onclick="highlight('B','thruster')"><div class="comp-dot" style="background:#ff4466"></div>TWIN THRUSTERS</button>
          <button class="comp-btn" onclick="highlight('B','vthruster')"><div class="comp-dot" style="background:#ff8844"></div>VERTICAL THRUSTER</button>
          <button class="comp-btn" onclick="highlight('B','battery')"><div class="comp-dot" style="background:#ffaa00"></div>LiPo 1S</button>
          <button class="comp-btn" onclick="highlight('B','compute')"><div class="comp-dot" style="background:#aa88ff"></div>ESP32-S3</button>
          <button class="comp-btn" onclick="highlight('B','none')"><div class="comp-dot" style="background:#333"></div>CLEAR ALL</button>
        </div>
      </div>
    </div>

  </div><!-- /infoPanel -->
</div><!-- /main -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ─── TAB LOGIC ────────────────────────────────────────────────────────────────
function setTab(n) {
  [0,1,2,3].forEach(i => {
    document.getElementById('t'+i).classList.toggle('on', i===n);
    document.getElementById('tab'+i).style.display = i===n ? '' : 'none';
  });
}
setTab(0);

// ─── SCENE FACTORY ────────────────────────────────────────────────────────────
function makeScene(canvasId, wrapId, bgColor) {
  const wrap = document.getElementById(wrapId);
  const canvas = document.getElementById(canvasId);

  const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: false });
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.shadowMap.enabled = true;
  renderer.setClearColor(bgColor);

  const scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(bgColor, 0.025);

  const camera = new THREE.PerspectiveCamera(50, 1, 0.01, 500);
  camera.position.set(15, 12, 18);
  camera.lookAt(0, 0, 0);

  scene.add(new THREE.AmbientLight(0x112244, 1.5));
  const dir = new THREE.DirectionalLight(0x88ccff, 1.2);
  dir.position.set(10, 20, 10);
  scene.add(dir);
  const rim = new THREE.DirectionalLight(0x004466, 0.8);
  rim.position.set(-10, -5, -10);
  scene.add(rim);

  // grid floor
  const grid = new THREE.GridHelper(40, 20, 0x00d4ff, 0x00d4ff);
  grid.material.opacity = 0.07; grid.material.transparent = true;
  grid.position.y = -4;
  scene.add(grid);

  // Orbit state
  let sph = {theta: 0.6, phi: 1.1, r: 25};
  let target = {...sph};
  let dragging = false;
  let prev = {x:0,y:0};

  canvas.addEventListener('mousedown', e => { dragging=true; prev={x:e.clientX,y:e.clientY}; });
  window.addEventListener('mouseup', () => dragging=false);
  canvas.addEventListener('mousemove', e => {
    if (!dragging) return;
    const dx=e.clientX-prev.x, dy=e.clientY-prev.y;
    target.theta -= dx*0.01; target.phi = Math.max(0.08, Math.min(Math.PI*0.48, target.phi+dy*0.01));
    prev={x:e.clientX,y:e.clientY};
  });
  canvas.addEventListener('wheel', e => {
    target.r = Math.max(8, Math.min(80, target.r+e.deltaY*0.05));
  });

  function updateCam() {
    sph.theta += (target.theta-sph.theta)*0.1;
    sph.phi   += (target.phi  -sph.phi  )*0.1;
    sph.r     += (target.r    -sph.r    )*0.1;
    camera.position.set(
      sph.r*Math.sin(sph.phi)*Math.sin(sph.theta),
      sph.r*Math.cos(sph.phi),
      sph.r*Math.sin(sph.phi)*Math.cos(sph.theta)
    );
    camera.lookAt(0, 0, 0);
  }

  function resize() {
    const w=wrap.clientWidth, h=wrap.clientHeight;
    renderer.setSize(w,h,false);
    camera.aspect=w/h; camera.updateProjectionMatrix();
  }
  window.addEventListener('resize', resize);
  resize();

  return { scene, camera, renderer, updateCam };
}

// ─── SHARED MATERIALS / UTILS ─────────────────────────────────────────────────
const MAT = {
  hull:    c => new THREE.MeshPhongMaterial({color:c, shininess:80}),
  metal:   c => new THREE.MeshPhongMaterial({color:c, shininess:120, specular:0xffffff}),
  rubber:  c => new THREE.MeshPhongMaterial({color:c, shininess:10, flatShading:true}),
  glow:    (c,e) => new THREE.MeshPhongMaterial({color:c, emissive:e||c, emissiveIntensity:0.6, shininess:30}),
  glass:   c => new THREE.MeshPhongMaterial({color:c, transparent:true, opacity:0.35, shininess:120}),
  wire:    c => new THREE.MeshBasicMaterial({color:c, wireframe:true}),
};

function label3D(scene, text, pos, color=0x00d4ff) {
  const cv = document.createElement('canvas'); cv.width=256; cv.height=64;
  const ctx = cv.getContext('2d');
  ctx.fillStyle='rgba(0,0,0,0)';
  ctx.fillRect(0,0,256,64);
  ctx.font='bold 20px "Share Tech Mono"';
  ctx.fillStyle=`#${color.toString(16).padStart(6,'0')}`;
  ctx.textAlign='center';
  ctx.fillText(text, 128, 38);
  const tex = new THREE.CanvasTexture(cv);
  const mat = new THREE.SpriteMaterial({map:tex, transparent:true, depthWrite:false});
  const sprite = new THREE.Sprite(mat);
  sprite.position.copy(pos);
  sprite.scale.set(6, 1.5, 1);
  scene.add(sprite);
  return sprite;
}

// ─── AMPHIBIOUS ROBOT BUILDER ────────────────────────────────────────────────
// Builds the Wedge-shaped Tracked Robot
function buildAmphibiousRobot(scene, type, map) {
  const root = new THREE.Group();
  scene.add(root);

  const isA = (type === 'A');
  const size = isA ? 1.0 : 0.6; // Scale factor
  const color = isA ? 0x00d4ff : 0xc41e3a;

  // === CHASSIS: WEDGE SHAPE ===
  const shape = new THREE.Shape();
  // Profile (Side view) - Nose at (0,0), Rear at (length, height)
  // Let's make it normalized length ~8
  shape.moveTo(0, 0);
  shape.lineTo(6, 0);      // Bottom
  shape.lineTo(6, 2.5);    // Rear Height
  shape.lineTo(2, 2.0);    // Top slope
  shape.lineTo(0, 0.5);    // Nose
  shape.lineTo(0, 0);

  const extrudeSettings = { steps: 1, depth: 4, bevelEnabled: true, bevelThickness: 0.1, bevelSize: 0.1, bevelSegments: 2 };
  const chassisGeo = new THREE.ExtrudeGeometry( shape, extrudeSettings );
  chassisGeo.center(); // Center the geometry

  const chassisMat = MAT.hull(isA ? 0x1a3a5c : 0x2a0a1a);
  const chassisMesh = new THREE.Mesh(chassisGeo, chassisMat);
  // Extrusion is along Z. We want Length along X (or Z).
  // Let's rotate so Length is X, Width is Z, Height is Y.
  // Original shape in XY plane. Extruded along Z.
  // Current: Length=X, Height=Y, Width=Z. This is good.
  root.add(chassisMesh);
  map.chassis = [chassisMesh];

  // Wireframe edge
  const edges = new THREE.LineSegments(new THREE.EdgesGeometry(chassisGeo), new THREE.LineBasicMaterial({color: color, transparent:true, opacity:0.3}));
  root.add(edges);

  // === TRACKS (Left & Right) ===
  const trackW = 0.8;
  const trackL = 7.0;
  const trackH = 1.8;
  const trackGeo = new THREE.BoxGeometry(trackL, trackH, trackW);
  const trackMat = MAT.rubber(0x111111);

  const tLeft = new THREE.Mesh(trackGeo, trackMat);
  tLeft.position.set(0, -0.5, 2.2); // Offset Z
  root.add(tLeft);

  const tRight = new THREE.Mesh(trackGeo, trackMat);
  tRight.position.set(0, -0.5, -2.2); // Offset -Z
  root.add(tRight);
  map.tracks = [tLeft, tRight];

  // Track Treads (Visual details)
  for(let side of [1, -1]) {
    for(let i=0; i<10; i++) {
      const tread = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.85, 0.85), MAT.metal(0x222222));
      tread.position.set(-3 + i*0.7, -0.5, side*2.2);
      root.add(tread);
      map.tracks.push(tread);
    }
  }

  // === TWIN REAR THRUSTERS ===
  const thrusterGrp = new THREE.Group();
  thrusterGrp.position.set(3.2, 0, 0); // Rear
  for(let side of [1, -1]) {
    const tBody = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.4, 1.2, 16), MAT.metal(0x333333));
    tBody.rotation.z = Math.PI/2;
    tBody.position.set(0, 0.5, side * 1.5);
    thrusterGrp.add(tBody);

    // Prop
    const prop = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.9, 0.2), MAT.metal(color));
    prop.position.set(0.6, 0.5, side * 1.5);
    thrusterGrp.add(prop);
  }
  root.add(thrusterGrp);
  map.thruster = [thrusterGrp];
  label3D(scene, 'TWIN THRUSTERS', new THREE.Vector3(5, 1, 0), color);

  // === VERTICAL THRUSTER (Top/Center) ===
  const vThruster = new THREE.Group();
  vThruster.position.set(0, 1.2, 0);
  const vtBody = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 0.8, 16), MAT.metal(0x333333));
  // Vertical cylinder
  vThruster.add(vtBody);
  const vtProp = new THREE.Mesh(new THREE.BoxGeometry(0.9, 0.1, 0.2), MAT.metal(color));
  vtProp.position.y = 0.2;
  vThruster.add(vtProp);
  root.add(vThruster);
  map.vthruster = [vThruster];
  label3D(scene, 'VERTICAL THRUST', new THREE.Vector3(0, 3.5, 0), 0xff8844);


  // === PAYLOAD / NOSE ===
  if (isA) {
    // TYPE A: BRUSH HEAD
    const brushGrp = new THREE.Group();
    brushGrp.position.set(-3.5, -0.8, 0); // Front bottom

    const bRoll = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 3.0, 16), MAT.hull(0x00aa44));
    bRoll.rotation.x = Math.PI/2; // Across width
    brushGrp.add(bRoll);

    // Bristles
    for(let i=0; i<8; i++) {
        const br = new THREE.Mesh(new THREE.BoxGeometry(0.1, 3.2, 0.8), MAT.glass(0x00ff88));
        br.rotation.x = Math.PI/2;
        br.rotation.z = i * (Math.PI/4);
        brushGrp.add(br);
    }
    root.add(brushGrp);
    map.brush = [brushGrp];
    label3D(scene, 'BRUSH HEAD', new THREE.Vector3(-4, -2.5, 0), 0x00ff88);

    // Internal Compute Indicator
    const comp = new THREE.Mesh(new THREE.BoxGeometry(1.5, 0.2, 1), MAT.glow(0x442266, 0xaa88ff));
    comp.position.set(0, 0.5, 0);
    root.add(comp);
    map.compute = [comp];

    // Battery
    const bat = new THREE.Mesh(new THREE.BoxGeometry(2, 0.6, 1.5), MAT.glow(0x664400, 0xffaa00));
    bat.position.set(-1, 0.2, 0);
    root.add(bat);
    map.battery = [bat];

  } else {
    // TYPE B: SENSOR NOSE
    const nose = new THREE.Mesh(new THREE.SphereGeometry(0.6, 16, 16), MAT.glow(0x440011, 0xff0044));
    nose.position.set(-3.1, 0, 0);
    root.add(nose);
    map.sensor = [nose]; // Using 'sensor' key if needed, or map to 'compute' visually

    // Internal Compute
    const comp = new THREE.Mesh(new THREE.BoxGeometry(1, 0.2, 0.8), MAT.glow(0x442266, 0xaa88ff));
    comp.position.set(0, 0.5, 0);
    root.add(comp);
    map.compute = [comp];

    // Battery
    const bat = new THREE.Mesh(new THREE.BoxGeometry(1, 0.3, 0.8), MAT.glow(0x664400, 0xffaa00));
    bat.position.set(-1, 0.2, 0);
    root.add(bat);
    map.battery = [bat];
  }

  // Scale the whole group
  root.scale.set(size, size, size);

  return root;
}

// ─── TYPE-A: POOL CLEANER ────────────────────────────────────────────────────
const scA = makeScene('cvA', 'wrapA', 0x05101f);
const partMapA = {};
const robotA = buildAmphibiousRobot(scA.scene, 'A', partMapA);
let hlA = null;

// ─── TYPE-B: TACTICAL ────────────────────────────────────────────────────────
const scB = makeScene('cvB', 'wrapB', 0x100510);
const partMapB = {};
const robotB = buildAmphibiousRobot(scB.scene, 'B', partMapB);
let hlB = null;

// ─── HIGHLIGHT SYSTEM ─────────────────────────────────────────────────────────
const origMatsA = {}, origMatsB = {};

function highlight(type, part) {
  const map = type==='A' ? partMapA : partMapB;
  const origMats = type==='A' ? origMatsA : origMatsB;

  // Restore all
  Object.values(map).forEach(meshes => {
    meshes.forEach(m => {
      m.traverse(child => {
        if (child.isMesh && origMats[child.uuid]) {
          child.material = origMats[child.uuid];
        }
      });
    });
  });

  if (part === 'none') {
    document.querySelectorAll('.comp-btn').forEach(b => b.classList.remove('on'));
    return;
  }

  document.querySelectorAll('.comp-btn').forEach(b => b.classList.remove('on'));
  event.currentTarget && event.currentTarget.classList.add('on');

  const targets = map[part] || [];
  targets.forEach(m => {
    m.traverse(child => {
      if (child.isMesh) {
        if (!origMats[child.uuid]) origMats[child.uuid] = child.material;
        child.material = new THREE.MeshPhongMaterial({
          color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.8,
          transparent: true, opacity: 0.9
        });
      }
    });
  });
}

// ─── ANIMATION LOOP ───────────────────────────────────────────────────────────
let t = 0;
function animate() {
  requestAnimationFrame(animate);
  t += 0.008;

  // Slow auto-rotate when not dragging
  robotA.rotation.y = t * 0.3;
  robotB.rotation.y = -t * 0.3;

  // Animate Tracks or Thrusters?
  // Maybe spin thrusters
  // Assuming map structure is consistent
  if(partMapA.thruster) {
      // Rotate props inside thruster group
      // This is a bit tricky with the group structure, let's keep it simple
  }

  scA.updateCam(); scA.renderer.render(scA.scene, scA.camera);
  scB.updateCam(); scB.renderer.render(scB.scene, scB.camera);
}
animate();
</script>
</body>
</html>
